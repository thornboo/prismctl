#!/usr/bin/env bash
set -euo pipefail

# Git hooks run on the working tree, not on the index snapshot.
# For predictable results, prefer committing from a clean working tree.

if [[ "${PRISMCTL_SKIP_HOOKS:-}" == "1" ]]; then
  exit 0
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -z "${repo_root}" ]]; then
  exit 0
fi

cd "${repo_root}"

unstaged="$(git diff --name-only --diff-filter=ACMR || true)"
if [[ -n "${unstaged}" ]]; then
  printf '%s\n' "pre-commit: detected unstaged changes (working tree != index)."
  printf '%s\n' "pre-commit: checks must run against the exact commit content; please stage or stash these changes first:"
  printf '%s\n' "${unstaged}" | sed 's/^/  - /'
  printf '%s\n' "pre-commit: you can bypass with: git commit --no-verify"
  exit 1
fi

echo "pre-commit: rustfmt check"
cargo fmtcheck

echo "pre-commit: clippy (deny warnings, locked)"
cargo lintlocked

echo "pre-commit: tests (all targets/features, locked)"
cargo testall --locked

echo "pre-commit: docs (deny warnings, locked)"
RUSTDOCFLAGS="-D warnings" cargo docall --locked
